{"type":"operationStart","subtype":"profile","data":{"_id":"YDu20008tnceBHQd","timestamp":"2024-01-14T17:39:51.315Z","state":"queued","mode":"standard","creationDate":"2024-01-14T17:39:51.321Z","modificationDate":"2024-01-14T17:39:51.321Z","shortid":"RObE7OO","$entitySet":"profiles"},"doDiffs":false,"timestamp":1705253991318,"id":"6tperm6latn8awq","previousOperationId":null,"operationId":"cjckw5qknimaziv"}
{"type":"log","level":"info","message":"Render request 1 queued for execution and waiting for available worker","previousOperationId":"cjckw5qknimaziv","timestamp":1705253991319,"id":"553ouig0q41ez97"}
{"type":"operationStart","subtype":"render","name":"orders-main","previousOperationId":"cjckw5qknimaziv","timestamp":1705253991382,"id":"xqgurm25bcttx94","previousEventId":"6tperm6latn8awq","operationId":"tojk7y6vbnjuhre"}
{"type":"log","timestamp":1705253991383,"level":"info","message":"Starting rendering request 1","meta":{"rootId":"q1jlkhwoq0xvbup","id":"q1jlkhwoq0xvbup"},"id":"d8bfugf0a8s5xvd","previousOperationId":"tojk7y6vbnjuhre"}
{"type":"log","timestamp":1705253991385,"level":"info","message":"Rendering template { name: orders-main, recipe: chrome-pdf, engine: handlebars, preview: true }","meta":{"rootId":"q1jlkhwoq0xvbup","id":"q1jlkhwoq0xvbup"},"id":"c9sib1tfzzubpwx","previousOperationId":"tojk7y6vbnjuhre"}
{"type":"log","timestamp":1705253991397,"level":"debug","message":"Data item not defined for this template.","meta":{"rootId":"q1jlkhwoq0xvbup","id":"q1jlkhwoq0xvbup"},"id":"f4v683jeoirswh3","previousOperationId":"tojk7y6vbnjuhre"}
{"type":"log","timestamp":1705253991402,"level":"debug","message":"Executing script orders-script (beforeRender)","meta":{"rootId":"q1jlkhwoq0xvbup","id":"q1jlkhwoq0xvbup"},"id":"6djb5yy5oqxrnbp","previousOperationId":"tojk7y6vbnjuhre"}
{"type":"operationStart","subtype":"scriptsBeforeRender","name":"scripts beforeRender","timestamp":1705253991745,"id":"j6p7wa3aqma2gh0","previousEventId":"xqgurm25bcttx94","operationId":"nfc7aam9btoyndo","previousOperationId":"tojk7y6vbnjuhre"}
{"type":"operationStart","subtype":"script","name":"scripts orders-script","previousOperationId":"nfc7aam9btoyndo","timestamp":1705253991745,"id":"0my1adzh7w44h68","previousEventId":"j6p7wa3aqma2gh0","operationId":"t2nmg1xiz1lmxn9"}
{"type":"log","timestamp":1705253991747,"level":"debug","message":"(console:log) { profilerMode: 'standard' }","meta":{"userLevel":true,"rootId":"q1jlkhwoq0xvbup","id":"q1jlkhwoq0xvbup"},"id":"m76akszfjimzqc9","previousOperationId":"t2nmg1xiz1lmxn9"}
{"type":"log","timestamp":1705253991784,"level":"warn","message":"Error when processing render request 1\n(because) error when evaluating custom script /samples/Orders/orders-script\nCannot read properties of undefined (reading 'reduce')\n\n(sandbox.js line 22:38)\n\n  20 | async function prepareDataSource() {\n  21 |   const orders = await fetchOrders();\n> 22 |   const ordersByShipCountry = orders.reduce((a, v) => {\n     |                                      ^\n  23 |     a[v.ShipCountry] = a[v.ShipCountry] || [];\n  24 |     a[v.ShipCountry].push(v);\n  25 |     return a;\n\n(sandbox.js line 57:21)\n\n  55 | async function beforeRender(req, res) {\n  56 |   console.log(req.context.http.query);\n> 57 |   req.data.orders = await prepareDataSource();\n     |                     ^\n  58 | }\n  59 |\n  60 | async function aaa() {\n\n\nTypeError: Cannot read properties of undefined (reading 'reduce')\n    at prepareDataSource (sandbox.js:22:38)\n    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)\n    at async Object.beforeRender (sandbox.js:57:21)\n    at async executionFn (C:\\Users\\arida\\Dev\\2DAM\\EventFlow\\jsreportapp\\node_modules\\@jsreport\\jsreport-scripts\\lib\\executeScript.js:67:11)\n    at async run (C:\\Users\\arida\\Dev\\2DAM\\EventFlow\\jsreportapp\\node_modules\\@jsreport\\jsreport-core\\lib\\worker\\sandbox\\createSandbox.js:137:16)\n    at async WorkerReporter.runInSandbox [as _runInSandbox] (C:\\Users\\arida\\Dev\\2DAM\\EventFlow\\jsreportapp\\node_modules\\@jsreport\\jsreport-core\\lib\\worker\\sandbox\\runInSandbox.js:195:14)\n    at async executeScript (C:\\Users\\arida\\Dev\\2DAM\\EventFlow\\jsreportapp\\node_modules\\@jsreport\\jsreport-scripts\\lib\\executeScript.js:122:12)\n    at async Scripts._runScript (C:\\Users\\arida\\Dev\\2DAM\\EventFlow\\jsreportapp\\node_modules\\@jsreport\\jsreport-scripts\\lib\\worker.js:140:30)\n    at async Scripts.handleBeforeRender (C:\\Users\\arida\\Dev\\2DAM\\EventFlow\\jsreportapp\\node_modules\\@jsreport\\jsreport-scripts\\lib\\worker.js:64:7)\n    at async ListenerCollection.fire (C:\\Users\\arida\\Dev\\2DAM\\EventFlow\\jsreportapp\\node_modules\\@jsreport\\jsreport-core\\lib\\shared\\listenerCollection.js:157:21)","meta":{"rootId":"q1jlkhwoq0xvbup","id":"q1jlkhwoq0xvbup"},"id":"ds6wdym6su4lyqx","previousOperationId":"t2nmg1xiz1lmxn9"}
{"type":"log","timestamp":1705253991784,"level":"warn","message":"Rendering request 1 finished with error in 470 ms","meta":{"rootId":"q1jlkhwoq0xvbup","id":"q1jlkhwoq0xvbup"},"id":"bk6epwnoiuii57n","previousOperationId":"t2nmg1xiz1lmxn9"}
{"type":"error","timestamp":1705253991802,"statusCode":400,"weak":true,"lineNumber":22,"decoratedSuffix":"\n\n(sandbox.js line 22:38)\n\n  20 | async function prepareDataSource() {\n  21 |   const orders = await fetchOrders();\n> 22 |   const ordersByShipCountry = orders.reduce((a, v) => {\n     |                                      ^\n  23 |     a[v.ShipCountry] = a[v.ShipCountry] || [];\n  24 |     a[v.ShipCountry].push(v);\n  25 |     return a;\n\n(sandbox.js line 57:21)\n\n  55 | async function beforeRender(req, res) {\n  56 |   console.log(req.context.http.query);\n> 57 |   req.data.orders = await prepareDataSource();\n     |                     ^\n  58 | }\n  59 |\n  60 | async function aaa() {\n\n","entity":{"shortid":"BJX1Jw82ce","name":"orders-script","content":"// server side script fetching remote data and preparing report data source\nconst http = require(\"http\");\n\n// call remote http rest api\nfunction fetchOrders() {\n  return new Promise((resolve, reject) => {\n    http.get(\n      `http://localhost:8080/api/locations/count-localizaciones`,\n      (result) => {\n        var str = \"\";\n        result.on(\"data\", (b) => (str += b));\n        result.on(\"error\", reject);\n        result.on(\"end\", () => resolve(JSON.parse(str).value));\n      }\n    );\n  });\n}\n\n// group the data for report\nasync function prepareDataSource() {\n  const orders = await fetchOrders();\n  const ordersByShipCountry = orders.reduce((a, v) => {\n    a[v.ShipCountry] = a[v.ShipCountry] || [];\n    a[v.ShipCountry].push(v);\n    return a;\n  }, {});\n\n  return Object.keys(ordersByShipCountry)\n    .map((country) => {\n      const ordersInCountry = ordersByShipCountry[country];\n\n      const accumulated = {};\n\n      ordersInCountry.forEach((o) => {\n        o.OrderDate = new Date(o.OrderDate);\n        const key =\n          o.OrderDate.getFullYear() + \"/\" + (o.OrderDate.getMonth() + 1);\n        accumulated[key] = accumulated[key] || {\n          value: 0,\n          orderDate: o.OrderDate,\n        };\n        accumulated[key].value++;\n      });\n\n      return {\n        rows: ordersInCountry,\n        country,\n        accumulated,\n      };\n    })\n    .slice(0, 2);\n}\n\n// add jsreport hook which modifies the report input data\nasync function beforeRender(req, res) {\n  console.log(req.context.http.query);\n  req.data.orders = await prepareDataSource();\n}\n\nasync function aaa() {\n  return req.context.http.query;\n  req.data.orders = await prepareDataSource();\n}\n"},"property":"content","logged":true,"previousOperationId":"t2nmg1xiz1lmxn9","id":"9ean30xm38tibbe","stack":"TypeError: Cannot read properties of undefined (reading 'reduce')\n    at prepareDataSource (sandbox.js:22:38)\n    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)\n    at async Object.beforeRender (sandbox.js:57:21)\n    at async executionFn (C:\\Users\\arida\\Dev\\2DAM\\EventFlow\\jsreportapp\\node_modules\\@jsreport\\jsreport-scripts\\lib\\executeScript.js:67:11)\n    at async run (C:\\Users\\arida\\Dev\\2DAM\\EventFlow\\jsreportapp\\node_modules\\@jsreport\\jsreport-core\\lib\\worker\\sandbox\\createSandbox.js:137:16)\n    at async WorkerReporter.runInSandbox [as _runInSandbox] (C:\\Users\\arida\\Dev\\2DAM\\EventFlow\\jsreportapp\\node_modules\\@jsreport\\jsreport-core\\lib\\worker\\sandbox\\runInSandbox.js:195:14)\n    at async executeScript (C:\\Users\\arida\\Dev\\2DAM\\EventFlow\\jsreportapp\\node_modules\\@jsreport\\jsreport-scripts\\lib\\executeScript.js:122:12)\n    at async Scripts._runScript (C:\\Users\\arida\\Dev\\2DAM\\EventFlow\\jsreportapp\\node_modules\\@jsreport\\jsreport-scripts\\lib\\worker.js:140:30)\n    at async Scripts.handleBeforeRender (C:\\Users\\arida\\Dev\\2DAM\\EventFlow\\jsreportapp\\node_modules\\@jsreport\\jsreport-scripts\\lib\\worker.js:64:7)\n    at async ListenerCollection.fire (C:\\Users\\arida\\Dev\\2DAM\\EventFlow\\jsreportapp\\node_modules\\@jsreport\\jsreport-core\\lib\\shared\\listenerCollection.js:157:21)","message":"Error when evaluating custom script /samples/Orders/orders-script\nCannot read properties of undefined (reading 'reduce')\n\n(sandbox.js line 22:38)\n\n  20 | async function prepareDataSource() {\n  21 |   const orders = await fetchOrders();\n> 22 |   const ordersByShipCountry = orders.reduce((a, v) => {\n     |                                      ^\n  23 |     a[v.ShipCountry] = a[v.ShipCountry] || [];\n  24 |     a[v.ShipCountry].push(v);\n  25 |     return a;\n\n(sandbox.js line 57:21)\n\n  55 | async function beforeRender(req, res) {\n  56 |   console.log(req.context.http.query);\n> 57 |   req.data.orders = await prepareDataSource();\n     |                     ^\n  58 | }\n  59 |\n  60 | async function aaa() {\n\n"}
